<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Trends - MonthVest</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin: 0; font-family: Arial; background: #f5f6fa; }
.sidebar { width: 220px; background: #6a11cb; height: 100vh; padding: 20px; position: fixed; color: #fff; }
.sidebar a { display: block; padding: 10px; color: #fff; text-decoration: none; margin-bottom: 10px; }
.main-content { margin-left: 240px; padding: 30px; }
.box { background: white; padding: 20px; border-radius: 10px; width: 23%; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.summary-boxes { display: flex; gap: 20px; flex-wrap: wrap; }
canvas { background: white; padding: 10px; border-radius: 10px; margin-top: 30px; }
</style>
</head>

<body>
    {% include "_navbar.html" %}


 <!-- SIDEBAR -->
    <div class="sidebar">
        <a href="{{ url_for('dashboard') }}">
            <i class="fas fa-home"></i> Dashboard
        </a>

        <a href="{{ url_for('add_investment_page') }}" class="active">
            <i class="fas fa-plus"></i> Add Investment
        </a>

        <a href="{{ url_for('add_stock_page') }}">
            <i class="fas fa-chart-line"></i> Add Stock
        </a>

        <a href="{{ url_for('edit_delete_page') }}">
            <i class="fas fa-edit"></i> Edit / Delete
        </a>

        <a href="{{ url_for('portfolio_trends_page') }}">
            <i class="fas fa-chart-line"></i> Portfolio Trends
        </a>

        <a href="{{ url_for('investment_tips_page') }}">
            <i class="fas fa-lightbulb"></i> Investment Tips
        </a>

        <a href="{{ url_for('reports_page') }}">
            <i class="fas fa-file-alt"></i> Reports
        </a>

        <a href="{{ url_for('user_profile_page') }}">
            <i class="fas fa-user"></i> User Profile
        </a>

        <a href="{{ url_for('logout') }}" class="logout">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>


<div class="main-content">

    <h2>Portfolio Trends</h2>

    <div class="summary-boxes">
        <div class="box">
            <h3>Best Performing</h3>
            <p id="bestCat">-</p>
        </div>

        <div class="box">
            <h3>Worst Performing</h3>
            <p id="worstCat">-</p>
        </div>

        <div class="box">
            <h3>Total Invested</h3>
            <p id="totalInvested">0</p>
        </div>

        <div class="box">
            <h3>Total Returns</h3>
            <p id="totalReturns">0</p>
        </div>
    </div>

    <canvas id="barChart" height="120"></canvas>
    <canvas id="lineChart" height="120"></canvas>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    loadTotalInvestment();
    loadTotalReturns();
    loadBestWorst();
    loadCharts();
});

/* ---------- TOTAL INVESTED (SAME AS REPORTS) ---------- */
async function loadTotalInvestment() {
    const res = await fetch("/api/total-investment", {
        credentials: "same-origin"
    });
    const data = await res.json();

    document.getElementById("totalInvested").innerText =
        data.success ? `₹${Number(data.totalInvestment).toFixed(2)}` : "₹0";
}

/* ---------- TOTAL RETURNS (STOCKS + INVESTMENTS) ---------- */
async function loadTotalReturns() {
    let totalProfit = 0;

    const invRes = await fetch("/get_investments", { credentials: "same-origin" });
    const invData = await invRes.json();
    if (invData.success) {
        invData.investments.forEach(i => {
            totalProfit += Number(i.current_value) - Number(i.amount);
        });
    }

    const stockRes = await fetch("/get_stock_reports", { credentials: "same-origin" });
    const stockData = await stockRes.json();
    if (stockData.success) {
        stockData.stocks.forEach(s => {
            totalProfit += Number(s.profit);
        });
    }

    document.getElementById("totalReturns").innerText =
        `₹${totalProfit.toFixed(2)}`;
}

/* ---------- BEST & WORST PERFORMING ---------- */
async function loadBestWorst() {
    let all = [];

    const inv = await fetch("/get_investments", { credentials: "same-origin" });
    const invData = await inv.json();
    if (invData.success) {
        invData.investments.forEach(i => {
            all.push({
                type: i.investment_type,
                profit: Number(i.current_value) - Number(i.amount)
            });
        });
    }

    const stocks = await fetch("/get_stock_reports", { credentials: "same-origin" });
    const stockData = await stocks.json();
    if (stockData.success) {
        stockData.stocks.forEach(s => {
            all.push({
                type: s.symbol,
                profit: Number(s.profit)
            });
        });
    }

    if (all.length === 0) return;

    const best = all.reduce((a, b) => a.profit > b.profit ? a : b);
    const worst = all.reduce((a, b) => a.profit < b.profit ? a : b);

    document.getElementById("bestCat").innerText =
        `${best.type} (₹${best.profit.toFixed(2)})`;

    document.getElementById("worstCat").innerText =
        `${worst.type} (₹${worst.profit.toFixed(2)})`;
}

/* ---------- CHARTS ---------- */
async function loadCharts() {
    let labels = [];
    let profits = [];
    let amounts = [];

    const inv = await fetch("/get_investments", { credentials: "same-origin" });
    const invData = await inv.json();
    if (invData.success) {
        invData.investments.forEach(i => {
            labels.push(i.investment_type);
            profits.push(Number(i.current_value) - Number(i.amount));
            amounts.push(Number(i.amount));
        });
    }

    new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Profit / Loss",
                data: profits
            }]
        }
    });

    new Chart(document.getElementById("lineChart"), {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Investment Amount",
                data: amounts
            }]
        }
    });
}
</script>


</body>
</html>
